# 基于静态分析的移动端安全分析平台

## 概述

随着目前移动互联网技术的高速发展,智能移动终端在消费市场中迅速崛起,成为人们生活中不可或缺的生产生活工具。安卓（Android）作为一。款面向移动端的智能操作系统,自2011年以来已经成功地取代了其它手机系统,并且常年在全球移动操作系统市场中占据统治地位。截止2020年5月,安卓操作系统的市场占有率超过70%,已然走入千家万户并且悄无声息地改变着人们的生产生活方式。手机上成千上万的移动应用程序给用户提供了社交、购物、游戏、工作、娱乐全方位的体验,丰富了人们的生活，但也增加了用户隐私泄露的危险。该应用所连接的远程服务器接口是否安全，该应用是否会非法读取用户隐私成为社会广泛关注的问题。

## 项目介绍

本项目分别从应用程序与第三方平台的Web通信和应用程序所需本地权限两个方面对应用程序进行安全性分析。

### Web通信

首先我们需要恢复出应用程序与第三方平台交互时所需要的URL信息。我们主要采用了静态分析的方法，首先，用soot绘制出该程序的控制流程图和数据依赖图，通过对应用程序进行反向切片，使之可以较好地恢复出目标方法的参数。之后用该工具恢复大量app应用在通信时的url信息，进一步得到应用和第三方服务端的交互信息。最后用已知的开源的url安全工具对已恢复的资源文件进行url安全性检测，得出我们所需的数据。

### 隐私保护

因为Android是以Linux为内核开发的移动设备开源系统，在Andoird中保留了Linux中的一些安全机制，为了让用户知道应用程序的隐私权限使用情况，Android 要求开发者预先申明需要使用的隐私权限，用户在安装应用程序时需要对这些权限请求进行授权。具体来说，Android 系统中每个开发者开发的应用程序被分配 1 个唯一的用户 ID，而每个用户 ID 访问的权限集合是受限的，没有任何一个 Android 移动应用程序可以在默认情况下直接访问其他应用程序。开发者在应用程序的开发过程中，必须把要使用的权限通过〈uses-permission〉标签在 AndroidManifest.xml 文件中进行申明．而用户在安装移动应用程序前会被告知这个应用程序需要使用的用户隐私权限．只有在这些权限被用户授权的情况下，Android 应用程序才能允许在运行过程中使用相关功能．因此，我们通过对安卓的manifest文件进行解析，便可初步得到应用程序需要使用的系统权限。

## 具体实现

### 绘制函数调用图

为了对整个应用程序地执行流程有比较好地掌控，首先我们需要绘制出整个程序的函数调用图。我们用soot解析目标应用程序，得到该应用程序中定义的类和方法，将每一个方法保存为图中的节点，节点中同时保存了在该方法中被调用的节点集合以及调用了该方法的节点集和。

如果存在应用类或系统类，我们会单独将其保存在一个fieldsetter集和中，这个集和将作为之后反向切片操作的一个终止条件。

### 反向切片

为了生成数据依赖图，我们需要自定义两种数据结构，分别是ValuePoint和HeapObject。其中ValuePoint储存了目标方法的地址，反向切片的路径，以及反向切片所得的最终结果；HeapObject对应一个类中的成员变量，它存储了该类中所有会对该成员变量产生影响的方法。除此之外，我们还需要为每个valuepoint维护一个"感兴趣的变量列表"。

将目标方法及该方法的特定参数作为输入，作为切片的起始位置。查找应用程序中调用该方法的位置，每个位置对应一个valuepoint节点，将其存入数据依赖图中，该节点"感兴趣的变量列表"中的初始元素为该方法的特定参数。依次对所有方法所在的basic block的语句进行反向遍历，找到左值存在于"感兴趣的变量列表"中的表达式，将左值从"感兴趣的变量列表"中移除，再对右值进行操作：如果右值是一个类的成员变量，则创建新的HeapObject；如果是一个表达式，则将该表达式的相关参数加入到"感兴趣的变量"中，并将该表达式压入”字符串计算栈“里；如果是一个常量字符串，则停止运行。一直循环重复该过程，直到字符串计算栈为空。

#### 分支语句的处理

当遍历到basicblock的第一条表达式时，需要判断当前位置是位于某个函数的起始语句块还是函数内的语句块。如果是函数的起始语句，需要找到调用该函数的语句，并继续往前追溯。如果是函数内的语句块，则表明有多个基本块指向当前块，则需要将所有前继加入到反向切片的列表中依次遍历。当程序的分支深度很深，条件很多时，路径复杂度会成指数级增长，导致程序无法顺利运行。但经过实验发现，很多情况下，程序的分支判断与我们所感兴趣的变量内容并没有直接关系，不同分支路径下恢复出来的字符串其实是相同的，因此我们通过给每个节点设置一个分支上限（我们设置为200），当该节点的分支数超过这个上限，则不再遍历更多的路径，以此初步解决了路径爆炸的问题，虽然这种做法会对精度产生一定影响。

### 正向恢复

当完成反向切片后，我们得到了所需地数据依赖图。这个依赖图是一个森林结构，以我们的目标方法参数为根节点(valuepoint)，解析这个根节点valuepoint，可以得到heapobject子节点，再由heapobject查找出更多的子节点valuepoint。正向解析valuepoint，便是从子节点开始，不断弹出"字符串计算栈"的表达式，根据表达式模拟计算参数，得到结果并保存到上一级的heapobject中。不断执行，最终便可计算出最终根节点的值。

![image-20210514215546602](readme/image-20210514215546602.png)



## 示例





## 统计数据